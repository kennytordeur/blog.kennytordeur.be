---
layout: post
title: "Entity Framework: Database Migrations"
date: 2012-08-14 10:21:00 +0200
comments: true
published: true
categories: ["blog", "archives"]
tags: ["Database migrations", "EF", "Entity Framework"]
alias: ["/post/Entity-Framework-Database-Migrations", "/post/entity-framework-database-migrations"]
---
<!-- more -->
{% include imported_disclaimer.html %}
<p>If you don&rsquo;t like writing SQL DDL statement, like me, than Entity Framework is very handy. With the Code-First, you can write your model and don&rsquo;t need to worry about your database. It is generated for you by Entity Framework. This is very handy but what if you are working with an existing database? Or if you need to support different versions of your database? That is where database migrations come in to play.</p>
<h1>Before we start</h1>
<ol>
<li>Create an Asp.Net MVC 4 application</li>
<li>Use Nuget to install the latest version of the Entity Framework (5.0.0-rc)</li>
</ol>
<p>Because i am not running an SQL Express or SQL Server on my machine, i am also going to install SqlServerCompact so i can work with an SDF file. This needs a little more configuration.</p>
<ol>
<li>Install EntityFramework.SqlServerCompact form Nuget.</li>
<li>Change the connectionstring in the web.config<br />&nbsp; <span style="color: blue;">&lt;</span><span style="color: #a31515;">connectionStrings</span><span style="color: blue;">&gt;<br />&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515;">add </span><span style="color: red;">name</span><span style="color: blue;">=</span>"<span style="color: blue;">DefaultConnection</span>" <span style="color: red;">connectionString</span><span style="color: blue;">=</span>"<span style="color: blue;">Data Source=|DataDirectory|\DBTest.sdf;Max Database Size=2047</span>" <span style="color: red;">providerName</span><span style="color: blue;">=</span>"<span style="color: blue;">System.Data.SqlServerCe.4.0</span>" <span style="color: blue;">/&gt;&nbsp;&nbsp;&nbsp; <br />&nbsp; &lt;/</span><span style="color: #a31515;">connectionStrings</span><span style="color: blue;">&gt;</span></li>
</ol>
<p>Create your models. In my case i will create as Car and Make class.</p>
<pre class="code"><span style="color: blue;">namespace </span>EF_DatabaseMigrations.Models<br />{<br />    <span style="color: blue;">public class </span><span style="color: #2b91af;">Car<br />    </span>{<br />        <span style="color: blue;">public </span><span style="color: #2b91af;">Int32 </span>Id { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br /><br />        <span style="color: blue;">public </span><span style="color: #2b91af;">String </span>Model { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br /><br />        <span style="color: blue;">public </span><span style="color: #2b91af;">Make </span>Make { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br />    }<br /><br />    <span style="color: blue;">public class </span><span style="color: #2b91af;">Make<br />    </span>{<br />        <span style="color: blue;">public </span><span style="color: #2b91af;">Int32 </span>Id { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br /><br />        <span style="color: blue;">public </span><span style="color: #2b91af;">String </span>Name { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br />    }<br />}</pre>
<p>&nbsp;</p>
<p>Next i will create a DbDatasource that will map my entities to the database. This datasource will pass the name of the connectionstring to the base constructor.</p>
<pre class="code"><span style="color: blue;">namespace </span>EF_DatabaseMigrations.DB<br />{<br />    <span style="color: blue;">public class </span><span style="color: #2b91af;">DbDatasource </span>: <span style="color: #2b91af;">DbContext<br />    </span>{<br />        <span style="color: blue;">public </span>DbDatasource()<br />            : <span style="color: blue;">base</span>(<span style="color: #a31515;">"DefaultConnection"</span>)<br />        { }<br /><br />        <span style="color: blue;">public </span><span style="color: #2b91af;">DbSet</span>&lt;<span style="color: #2b91af;">Car</span>&gt; Cars { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br /><br />        <span style="color: blue;">public </span><span style="color: #2b91af;">DbSet</span>&lt;<span style="color: #2b91af;">Make</span>&gt; Makes { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br />    }<br />}</pre>
<p>&nbsp;</p>
<h1>Let&rsquo;s migrate</h1>
<p>&nbsp;</p>
<p>To configure your application to use migrations, you have to type &ldquo;enable-migrations&rdquo; command in the Package Manager Console. This will create a Migrations folder that contains a Configuration file. This class contains a seed method that accepts the DbDatasource as a parameter. The seed method will always be execute when you update your database. This method will typically be used to create users in the database or in our case to create the Makes in our database.&nbsp; By default, AutomaticMigrationsEnabled will be set to false. Since we want to automate everything, we need to set it to true :-).</p>
<p>&nbsp;</p>
<blockquote>
<pre class="code"><span style="color: blue;">namespace </span>EF_DatabaseMigrations.Migrations<br />{<br />    <span style="color: blue;">internal sealed class </span><span style="color: #2b91af;">Configuration </span>: <span style="color: #2b91af;">DbMigrationsConfiguration</span>&lt;EF_DatabaseMigrations.DB.<span style="color: #2b91af;">DbDatasource</span>&gt;<br />    {<br />        <span style="color: blue;">public </span>Configuration()<br />        {<br />            AutomaticMigrationsEnabled = <span style="color: blue;">true</span>;<br />        }<br /><br />        <span style="color: blue;">protected override void </span>Seed(EF_DatabaseMigrations.DB.<span style="color: #2b91af;">DbDatasource </span>context)<br />        {<br />            context.Makes.AddOrUpdate(m =&gt; m.Name, <span style="color: blue;">new </span><span style="color: #2b91af;">Make </span>{ Name = <span style="color: #a31515;">"Ford" </span>}<br />                                                 , <span style="color: blue;">new </span><span style="color: #2b91af;">Make </span>{ Name = <span style="color: #a31515;">"Opel" </span>}<br />                                                 , <span style="color: blue;">new </span><span style="color: #2b91af;">Make </span>{ Name = <span style="color: #a31515;">"BMW" </span>});<br />        }<br />    }<br />}</pre>
</blockquote>
<p>&nbsp;</p>
<p>Because the Seed method is always called, we have to make sure that the Makes we are adding, only are getting inserted if they don&rsquo;t exists or are updated when they do exists the database. That is why we are using the AddOrUpdate methode. The first parameter is in fact our condition for the insert or update. If a make with a name &ldquo;Ford&rdquo; doesn&rsquo;t exists in the database, it is inserted. If it does exists, it gets updated.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>When we type &ldquo;update-database&rdquo; command in the Package Manager Console, EF will create our database and will call the Seed method. The location of the database will be determined by the connectionstring that you specify. In our case it will be found in the App_Data folder.</p>
<p>&nbsp;</p>
<p>When we open the database, we see that a Cars and a Makes table are created. The Makes table is pre-filled.</p>
<p>&nbsp;</p>
<p>&nbsp;<a href="http://lh6.ggpht.com/-vKhzBJYgJuc/UComVwfwiyI/AAAAAAAAAGE/OYdpaeOiHR8/s1600-h/image%25255B3%25255D.png"><img style="display: block; float: none; margin-left: auto; margin-right: auto; border: 0px;" title="image" src="http://lh6.ggpht.com/-jSSpn0Ulqi0/UComWt61psI/AAAAAAAAAGI/lJ_1vASmgjM/image_thumb%25255B1%25255D.png?imgmax=800" alt="image" width="359" height="124" border="0" /></a></p>
<p>&nbsp;</p>
<p>In the table &ldquo;_MigrationHistory&rdquo; all migrations that where performed on this database are stored. That way you can always see what version of database this is. Also Entity Framework will need this information.</p>
<p>&nbsp;</p>
<p>Now let&rsquo;s assume that we want to add a BuildDate property to the Car. We can put this in a new migration. This way we can keep track of all our modifications in our database.</p>
<p>&nbsp;</p>
<h2>Change the Car entity.</h2>
<p>&nbsp;</p>
<pre class="code"><span style="color: blue;">public class </span><span style="color: #2b91af;">Car<br /></span>{<br />    <span style="color: blue;">public </span><span style="color: #2b91af;">Int32 </span>Id { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br /><br />    <span style="color: blue;">public </span><span style="color: #2b91af;">String </span>Model { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br /><br />    <span style="color: blue;">public </span><span style="color: #2b91af;">Make </span>Make { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br /><br />    <span style="color: blue;">public </span><span style="color: #2b91af;">DateTime </span>BuildDate { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br />}</pre>
<p>&nbsp;</p>
<h2>Add Migration</h2>
<p>&nbsp;</p>
<p>Type &ldquo;add-migration AddBuildDate&rdquo; in the Package Manager Console. This will create a new file in the Migration folder. The file name will contain the date + the name that we specified.</p>
<p>&nbsp;</p>
<p>This new file will contain 2 methods that we can override. The &ldquo;Up&rdquo; method will contain all new database modifications. The &ldquo;Down&rdquo; will contain the rollback of the modifications. This way we can easily &ldquo;jump&rdquo; through database versions. We manually add the AddColumn and DropColumn statements.</p>
<pre class="code"><span style="color: blue;">namespace </span>EF_DatabaseMigrations.Migrations<br />{<br />    <span style="color: blue;">public partial class </span><span style="color: #2b91af;">AddBuildDate </span>: <span style="color: #2b91af;">DbMigration<br />    </span>{<br />        <span style="color: blue;">public override void </span>Up()<br />        {<br />            AddColumn(<span style="color: #a31515;">"dbo.Cars"</span>, <span style="color: #a31515;">"BuildDate"</span>, c =&gt; c.DateTime(nullable: <span style="color: blue;">false</span>));<br />        }<br /><br />        <span style="color: blue;">public override void </span>Down()<br />        {<br />            DropColumn(<span style="color: #a31515;">"dbo.Cars"</span>, <span style="color: #a31515;">"BuildDate"</span>);<br />        }<br />    }<br />}</pre>
<p>&nbsp;</p>
<p>When we want to apply those modifications, we need to type &ldquo;update-database -TargetMigration:AddBuildDate&rdquo;. This will modify our database and add the new column.</p>
<p>&nbsp;</p>
<p><a href="http://lh3.ggpht.com/-mhKvKHmKl40/UComXMyADMI/AAAAAAAAAGQ/Om7QD66ViK0/s1600-h/image%25255B7%25255D.png"><img style="display: block; float: none; margin-left: auto; margin-right: auto; border: 0px;" title="image" src="http://lh6.ggpht.com/-Drk6QCNjNqw/UComX3YgBoI/AAAAAAAAAGY/SFqsI2KEIho/image_thumb%25255B3%25255D.png?imgmax=800" alt="image" width="628" height="116" border="0" /></a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>If you want to rollback the database at it&rsquo;s begin state, you type &ldquo;update-database -TargetMigration:0&rdquo; in the Package Console Manager.</p>
<p>&nbsp;</p>
<h2>What about the database adminstrators</h2>
<p>&nbsp;</p>
<p>We can&rsquo;t forget these guys. They probably won&rsquo;t like this way of creating the database and would probably prefer a script. Well you can add an extra parameter to the &ldquo;update-database&rdquo; called script that will create a clean SQL script that performs all the necessary steps to create the database.</p>
<p>&nbsp;</p>
<p>&ldquo;update-database &ndash;TargetMigration:AddBuildDate &ndash;script&rdquo; will create this script:</p>
<pre class="code"><span style="color: blue;">ALTER TABLE </span><span style="color: teal;">[Cars] </span><span style="color: blue;">ADD </span><span style="color: teal;">[BuildDate] [datetime]<br /></span><span style="color: blue;">INSERT INTO </span><span style="color: teal;">[__MigrationHistory] </span><span style="color: gray;">(</span><span style="color: teal;">[MigrationId]</span><span style="color: gray;">, </span><span style="color: teal;">[Model]</span><span style="color: gray;">, </span><span style="color: teal;">[ProductVersion]</span><span style="color: gray;">) </span><span style="color: blue;">VALUES </span><span style="color: gray;">(</span><span style="color: red;">'201208140904052_AddBuildDate'</span><span style="color: gray;">, </span>0x1F8B0800000000000400ECBD07601C499625262F6DCA7B7F4AF54AD7E074A10880601324D8904010ECC188CDE692EC1D69472329AB2A81CA6556655D661640CCED9DBCF7DE7BEFBDF7DE7BEFBDF7BA3B9D4E27F7DFFF3F5C6664016CF6CE4ADAC99E2180AAC81F3F7E7C1F3F22FEC7BFF71F7CFC7BBC5B94E9655E3745B5FCECA3DDF1CE4769BE9C56B36279F1D947EBF67CFBE0A3DFE3E8374E1E9FCE16EFD29F34EDF6D08EDE5C369F7D346FDBD5A3BB779BE93C5F64CD78514CEBAAA9CEDBF1B45ADCCD66D5DDBD9D9D83BBBB3B777302F111C14AD3C7AFD6CBB658E4FC07FD79522DA7F9AA5D67E517D52C2F1BFD9CBE79CD50D317D9226F56D934FFECA3D367BFFFD3ACCD2659937F515CD4594B0835E3A74F3E4A8FCB22237C5EE7E5F97B22B7F310C87D64BBA58E4F09C1F6FACDF52AE7CE3FFBE824ABFD06D4E4F7CAAF830FE8A39775B5CAEBF6FA557EAEAF9DCD3E4AEF86EFDDEDBE685FF3DE41CFF4DBB2BDB7F751FA625D96D9A4A40FCEB3B2C93F4A579F3E7ADD5675FE79BECC8904F9EC65D6B679BDC4BB3963AE1478B4FAF47644787877670F44B89B2D9755CB54ED21DE4193E7CA60FABAAD89653E4A9F15EFF2D9F37C79D1CE2DB65F64EFCC27FB3B3BC4395F2D0B62317AABADD7B93F3CF97B73B74FD645392316C84DD7F8FD0D7153844E1D482FB2CBE282C7D61D4AF6965ABFCA4B61A779B1123E1AD3ACFFFEF2E5B3BA5ABCAA00DB7CF6FBBFAED6F51468549D2FDE64F545DE86DD3FBEEB586A23A371773FE2341F4DFCFBB3CD6843F373DC34D5B460349D26F8FD239374BA9CA5430C22982B43119EEBB22D566531A5FE3EFBE85BBDE147401996F240095F86B076C6E3DDEEB8BC11F4198F546F9B1534B73AB8A71368D74610EF6285175EE7ADA343F351EAA8E68FB037A0F055A01E7B5786D479D9C33FE85C05D3FBBA2BB45DA1D93045164333AE1089CD93E2BDAC23EB0A62388608DBD97970B6EFAE183F6324EF0E58C9C75F64AB1589846735F593F4B598CC93EDD7EF6F101702E3EEB489D8458BADED897444769177BEA5AE09D36745DDB4C6667F949ECC16BD66B7E13AD395C77CFD2932FC641AE3777961C86F607EED0072247C46A35A909EE301EAF00C93F4DF4AE1B064655647D4EC4955AE17CB2155BDE96DB5B33E00FDE8F6303CA3E9C3F13EEEC37A7CB743842EB93D8DA92D3B5CDF9DBB5BCDAC48D03732B53125708BB98DBFF6B333B962DAFCF7E5931FFE74842AAA276DAA6D6F4175D7F8164203B5DA214957BDF62971AB796010B1C900216C9FEF818E9A8AAF89CE7B6342EA7156B0DB71D6C071B15ECE2D06D93538FD09EFD99D6E13CB6ED6FE74ECCC63D5F98131626A7443B69E1190261FA534F4CB620603F0FABA69F3C5180DC6AF7F51F93AAF29263DC9C7FB08344DB32FB265719E37ED9BEA6D4EB69EBFFBBA419FF5429B6656FEBF30F22B96ADCACF26CFFBA6806753C4B6BCCCEAE99CDDD1AEDBFC8101D98C7E4778FFFEF8196EF668F0757CF6DE14FEDCC4543F2B7328E6E183A6F01B0C759C5178AFA02480C101C3FB86483447790D126625A9B0A6AD4989F52CE24B0A15A7C52A2B7D6CFBFAFB36F30EAA5970DD6F9EE6AB7C8909F546749B6E3698280BB2C37D378DFB3DC3BDBE7FDE9DA55ECC3714F2895227E99F54349DC27BB1502A1A0C0EC68231A8F118EB67234CF45173AEE10DB1613798FCD98906FBD6979863BDB4695562CAA6B87020E04F2CF369C016B6CDD9F2BC32ECD9C1C834E9AAEABCCD48CF67C7755B9C67D396BE9EE64DC3A9999FCCCA3535395D4CF2D9D9F2CB75BB5AB734E47C3129AF7D6280CB37F5CF216F88F3E32F57EC677E134320340B98AA2F976CC12CDECFFA6A780804C447753BE6B2858EBFB8B6905E54CB5B0252F23D3552FF265FAC281999375F2E5F6797F9306E37D330A4D8E3A74546CEFAA249EF1E09D3787C42EC4739FAA3FF270000FFFFEA4946EC18180000<span style="color: gray;">, </span><span style="color: red;">'5.0.0-rc.net40'</span><span style="color: gray;">)<br /><br /></span></pre>
<p>&nbsp;</p>
<p>The Visual Studio solution can be downloaded <a href="http://dl.dropbox.com/u/41091233/Blog/Entity%20Framework%20Database%20Migrations/EF_DatabaseMigrations.rar" target="_blank">here</a>.</p>
