---
ID: 60
post_title: CSRF prevention in aspnet mvc 6
author: kennytordeur
post_date: 2015-11-25 13:45:00
post_excerpt: ""
layout: post
permalink: >
  http://wp.kennytordeur.be/2015/11/25/csrf-prevention-in-aspnet-mvc-6/
published: true
---
Cross-Site Request Forgery (CSRF) is an attack that forces an end user to execute unwanted actions on a web application in which they&#39;re currently authenticated. CSRF attacks specifically target state-changing requests, not theft of data, since the attacker has no way to see the response to the forged request. With a little help of social engineering (such as sending a link via email or chat), an attacker may trick the users of a web application into executing actions of the attacker&#39;s choosing. If the victim is a normal user, a successful CSRF attack can force the user to perform state changing requests like transferring funds, changing their email address, and so forth. If the victim is an administrative account, CSRF can compromise the entire web application. (from <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29">www.owasp.org</a>)

Luckily Asp.Net MVC has a build in mechanisme to fight those attacks. In the previous versions of Asp.Net MVC you used an AntiForgeryToken. You needed to put a ValidateAntiForgeryToken attribute on your MVC action or controller. In the view, you needed to instruct RAZOR to create an AntiForgeryToken. This will give the visitor a cookie called __RequestVerificationToken. This cookie will have the same value as a hidden input field, called __RequestVerificationToken, generated by the Html.AntiForgeryToken() method. This method needed to be placed inside a form tag or the using of a Html.BeginForm().

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp">   <span class="k">public</span> <span class="k">class</span> <span class="nc">MyController</span> <span class="p">:</span> <span class="n">Controller</span>
    <span class="p">{</span>
<span class="na">    [HttpPost]</span>
<span class="na">        [ValidateAntiForgeryToken]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Create</span><span class="p">(</span><span class="n">SomeModel</span> <span class="n">model</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><code class="language-html" data-lang="html">   @using(Html.BeginForm())
   {
    @Html.AntiForgeryToken()
   }
</code></pre></div>

In the Asp.Net MVC 6 the mechanisme has changed a bit. You still need to put the ValidateAntiForgeryToken attribute on your MVC action, but if you use the build in form taghelper, the forgerytoken will by default be created and placed within the form tag.

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp">   <span class="k">public</span> <span class="k">class</span> <span class="nc">MyController</span> <span class="p">:</span> <span class="n">Controller</span>
    <span class="p">{</span>
<span class="na">    [HttpPost]</span>
<span class="na">        [ValidateAntiForgeryToken]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Create</span><span class="p">(</span><span class="n">SomeModel</span> <span class="n">model</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><code class="language-html" data-lang="html">   <span class="nt">&lt;form</span> <span class="na">asp-action=</span><span class="s">&quot;Create&quot;</span><span class="nt">&gt;</span>

   <span class="nt">&lt;/form&gt;</span>
</code></pre></div>

The result html

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/My/Create/&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;__RequestVerificationToken&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;CfDJ8DCDWZ4iOzZDmNKl5HFAUd2qQe4qwOhVP4znwDlTDINNK_h-1a2v0A1aDPCdb4lEgc9X_cTsjKkCDUCYh9EKr7HqXI3hvIRfnRItwfJwbImCZIx38uDfwVu5jzdVZOcaXUUmoPBDtG6-0__0FVezb-U&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div>

If you don&#39;t want the forgerytoken to be created you can pass a false value to the form taghelper for the antiforgery parameter.

<div class="highlight"><pre><code class="language-html" data-lang="html">   <span class="nt">&lt;form</span> <span class="na">asp-action=</span><span class="s">&quot;Create&quot;</span> <span class="na">asp-antiforgery=</span><span class="s">&quot;false</span><span class="nt">&gt;</span>

   <span class="nt">&lt;/form&gt;</span>
</code></pre></div>