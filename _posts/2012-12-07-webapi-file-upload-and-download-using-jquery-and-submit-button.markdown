---
layout: post
title: "WebApi: File upload and download using JQuery and submit button"
date: 2012-12-07 10:15:00 +0100
comments: true
published: true
categories: ["blog", "archives"]
tags: ["JQuery", "MVC 4", "WebApi"]
alias: ["/post/WebApi-File-upload-and-download-using-JQuery-and-submit-button", "/post/webapi-file-upload-and-download-using-jquery-and-submit-button"]
---
<!-- more -->
{% include imported_disclaimer.html %}
<p>I am going to create a WebApi service called FileService that can be used to upload and download files. The service will only contain 2 methods. A Post to upload and a Get method that accepts an id parameter to identify the file that needs to be downloaded. Let&rsquo;s start with the Post method.</p>
<h1>The Post method</h1>
<p>This method will look in the Request object to see if there are any posted files. If so, it will loop over the files and create them on the server side. The server will return a 201 HttpStatus and a list of strings that will contain the full path of the file(s) at server side. When there are no files posted, the service will return a 401 status a.k.a. BadRequest.</p>
<pre class="code"><span style="color: blue;">public </span><span style="color: #2b91af;">HttpResponseMessage </span>Post()<br />       {<br />           <span style="color: #2b91af;">HttpResponseMessage </span>result = <span style="color: blue;">null</span>;<br />           <span style="color: blue;">var </span>httpRequest = <span style="color: #2b91af;">HttpContext</span>.Current.Request;<br /><br />           <span style="color: green;">// Check if files are available<br />           </span><span style="color: blue;">if </span>(httpRequest.Files.Count &gt; 0)<br />           {<br />               <span style="color: blue;">var </span>files = <span style="color: blue;">new </span><span style="color: #2b91af;">List</span>&lt;<span style="color: blue;">string</span>&gt;();<br /><br />               <span style="color: green;">// interate the files and save on the server<br />               </span><span style="color: blue;">foreach </span>(<span style="color: blue;">string </span>file <span style="color: blue;">in </span>httpRequest.Files)<br />               {<br />                   <span style="color: blue;">var </span>postedFile = httpRequest.Files[file];<br />                   <span style="color: blue;">var </span>filePath = <span style="color: #2b91af;">HttpContext</span>.Current.Server.MapPath(<span style="color: #a31515;">"~/" </span>+ postedFile.FileName);<br />                   postedFile.SaveAs( filePath);<br /><br />                   files.Add(filePath);<br />               }<br /><br />               <span style="color: green;">// return result<br />              </span>result = Request.CreateResponse(<span style="color: #2b91af;">HttpStatusCode</span>.Created, files);<br />           }<br />           <span style="color: blue;">else<br />           </span>{<br />               <span style="color: green;">// return BadRequest (no file(s) available)<br />               </span>result = Request.CreateResponse(<span style="color: #2b91af;">HttpStatusCode</span>.BadRequest);<br />           }<br /><br />           <span style="color: blue;">return </span>result;<br />       }</pre>
<p>&nbsp;</p>
<h1>The Get Method</h1>
<p>&nbsp;</p>
<p>As mentioned before, the Get Method will accept a string file that will identify (= filename) the file that needs to be downloaded.</p>
<pre class="code"><span style="color: blue;">public </span><span style="color: #2b91af;">HttpResponseMessage </span>Get(<span style="color: blue;">string </span>id)<br />       {<br />           <span style="color: #2b91af;">HttpResponseMessage </span>result = <span style="color: blue;">null</span>;<br />           <span style="color: blue;">var </span>localFilePath = <span style="color: #2b91af;">HttpContext</span>.Current.Server.MapPath(<span style="color: #a31515;">"~/" </span>+ id);<br /><br />           <span style="color: green;">// check if parameter is valid<br />           </span><span style="color: blue;">if </span>(<span style="color: #2b91af;">String</span>.IsNullOrEmpty(id))<br />           {<br />               result = Request.CreateResponse(<span style="color: #2b91af;">HttpStatusCode</span>.BadRequest);<br />           }<br />               <span style="color: green;">// check if file exists on the server<br />           </span><span style="color: blue;">else if </span>(!<span style="color: #2b91af;">File</span>.Exists(localFilePath))<br />           {<br />               result = Request.CreateResponse(<span style="color: #2b91af;">HttpStatusCode</span>.Gone);<br />           }<br />           <span style="color: blue;">else<br />           </span>{<span style="color: green;">// serve the file to the client<br />               </span>result = Request.CreateResponse( <span style="color: #2b91af;">HttpStatusCode</span>.OK);<br />               result.Content = <span style="color: blue;">new </span><span style="color: #2b91af;">StreamContent</span>(<span style="color: blue;">new </span><span style="color: #2b91af;">FileStream</span>(localFilePath, <span style="color: #2b91af;">FileMode</span>.Open, <span style="color: #2b91af;">FileAccess</span>.Read));<br />               result.Content.Headers.ContentDisposition = <span style="color: blue;">new </span>System.Net.Http.Headers.<span style="color: #2b91af;">ContentDispositionHeaderValue</span>(<span style="color: #a31515;">"attachment"</span>);<br />               result.Content.Headers.ContentDisposition.FileName = id;<br />           }<br /><br />           <span style="color: blue;">return </span>result;<br />       }</pre>
<p>&nbsp;</p>
<h1>Uploading a File</h1>
<p>&nbsp;</p>
<h2>Using a submit&nbsp; button</h2>
<pre class="code"> <span style="color: blue;">&lt;</span><span style="color: maroon;">form </span><span style="color: red;">name</span><span style="color: blue;">="form1" </span><span style="color: red;">method</span><span style="color: blue;">="post" </span><span style="color: red;">action</span><span style="color: blue;">="api/file" </span><span style="color: red;">enctype</span><span style="color: blue;">="multipart/form-data"&gt;<br />    &lt;</span><span style="color: maroon;">div</span><span style="color: blue;">&gt;<br />        &lt;</span><span style="color: maroon;">label</span><span style="color: blue;">&gt;<br />            </span>Using submit<span style="color: blue;">&lt;/</span><span style="color: maroon;">label</span><span style="color: blue;">&gt;<br />        &lt;</span><span style="color: maroon;">input </span><span style="color: red;">name</span><span style="color: blue;">="myFile" </span><span style="color: red;">type</span><span style="color: blue;">="file" /&gt;<br />    &lt;/</span><span style="color: maroon;">div</span><span style="color: blue;">&gt;<br />    &lt;</span><span style="color: maroon;">div</span><span style="color: blue;">&gt;<br />        &lt;</span><span style="color: maroon;">input </span><span style="color: red;">type</span><span style="color: blue;">="submit" </span><span style="color: red;">value</span><span style="color: blue;">="Submit" /&gt;<br />    &lt;/</span><span style="color: maroon;">div</span><span style="color: blue;">&gt;<br />    &lt;/</span><span style="color: maroon;">form</span><span style="color: blue;">&gt;</span></pre>
<p>&nbsp;</p>
<h2>&nbsp;</h2>
<p>&nbsp;</p>
<h2>Using JQuery</h2>
<pre class="code"><span style="color: blue;">&lt;</span><span style="color: maroon;">form </span><span style="color: red;">enctype</span><span style="color: blue;">="multipart/form-data"&gt;<br />    &lt;</span><span style="color: maroon;">label</span><span style="color: blue;">&gt;<br />        </span>Using JQuery<span style="color: blue;">&lt;/</span><span style="color: maroon;">label</span><span style="color: blue;">&gt;<br />    &lt;</span><span style="color: maroon;">input </span><span style="color: red;">name</span><span style="color: blue;">="file" </span><span style="color: red;">type</span><span style="color: blue;">="file" /&gt;<br />    &lt;</span><span style="color: maroon;">input </span><span style="color: red;">type</span><span style="color: blue;">="button" </span><span style="color: red;">id</span><span style="color: blue;">="Upload" </span><span style="color: red;">value</span><span style="color: blue;">="Upload" /&gt;<br />    &lt;/</span><span style="color: maroon;">form</span><span style="color: blue;">&gt;<br /></span></pre>
<pre class="code">        <span style="color: blue;">&lt;</span><span style="color: maroon;">script </span><span style="color: red;">type</span><span style="color: blue;">="text/javascript"&gt;<br />            </span>$(<span style="color: blue;">function </span>() {<br />                $(<span style="color: maroon;">'#Upload'</span>).click(<span style="color: blue;">function </span>() {<br />                    <span style="color: blue;">var </span>formData = <span style="color: blue;">new </span>FormData($(<span style="color: maroon;">'form'</span>)[0]);<br />                    $.ajax({<br />                        url: <span style="color: maroon;">'api/file'</span>, <br />                        type: <span style="color: maroon;">'POST'</span>,<br />                        <span style="color: #006400;">// Form data<br />                        </span>data: formData,<br />                        <span style="color: #006400;">//Options to tell JQuery not to process data or worry about content-type<br />                        </span>cache: <span style="color: blue;">false</span>,<br />                        contentType: <span style="color: blue;">false</span>,<br />                        processData: <span style="color: blue;">false<br />                    </span>});<br />                });<br />            });<br />        <span style="color: blue;">&lt;/</span><span style="color: maroon;">script</span><span style="color: blue;">&gt;<br /></span></pre>
<p>&nbsp;</p>
<h1>Downloading a File</h1>
<p>&nbsp;</p>
<p><a href="http://lh3.ggpht.com/-I5SBqwTkJek/UMHBZeu0iMI/AAAAAAAAAHM/rqrrr9XKnA0/s1600-h/image%25255B7%25255D.png"><img style="display: block; float: none; margin-left: auto; margin-right: auto; border-width: 0px;" title="image" src="http://lh6.ggpht.com/-7q2qvEH6OP4/UMHBakxWI3I/AAAAAAAAAHU/rXO1N3MjK3A/image_thumb%25255B5%25255D.png?imgmax=800" alt="image" width="583" height="319" border="0" /></a></p>
<p>&nbsp;</p>
<h1>Summary</h1>
<p>&nbsp;</p>
<p>The solution can be downloaded <a href="http://dl.dropbox.com/u/41091233/Blog/WebApi%20File%20Upload/WebApi%20FileUpload.rar" target="_blank">here</a>.</p>
